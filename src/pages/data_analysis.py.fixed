import streamlit as st
import pandas as pd
import os
import tempfile
import uuid
import re
import time
from src.auth.auth import is_logged_in, update_settings
from src.utils.data_processing import load_data_file, process_data, infer_column_descriptions
from src.visualization.code_generation import create_chart
from src.ai.llm_agent import get_response
from src.web_utils.ui_elements import display_sidebar_user_info, display_error, display_success, display_code, display_dataframe_info
from src.database.mysql import connect_mysql, get_mysql_tables, get_mysql_table_data, close_mysql_connection
from src.visualization.code_execution import execute_code
from src.ai.streaming import get_streaming_response

st.set_page_config(
    page_title="æ•°æ®åˆ†æ | æ•°æ®åˆ†æåŠ©æ‰‹",
    page_icon="ğŸ“Š",
    layout="wide"
)

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if not is_logged_in():
    st.warning("è¯·å…ˆç™»å½•")
    st.switch_page("pages/login.py")

# è®¾ç½®é¡µé¢æ ·å¼
st.markdown("""
<style>
    .main {
        padding: 1rem;
    }
    .stButton>button {
        border-radius: 20px;
        height: 3em;
        background: linear-gradient(90deg, #FF6B6B 0%, #FF8E53 100%);
        border: none;
        color: white;
        font-weight: bold;
    }
    .stButton>button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }
    .analysis-section {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    .chat-message {
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    .user-message {
        background-color: #F0F2F6;
        border-left: 5px solid #7E57C2;
    }
    .ai-message {
        background-color: #F9F9F9;
        border-left: 5px solid #26A69A;
    }
    .chat-container {
        height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
    }
    .code-container {
        height: 60vh;
        overflow-y: auto;
        padding-left: 10px;
    }
    div[data-testid="stExpander"] div[role="button"] p {
        font-size: 1.1rem;
    }
    div[data-testid="stChatMessage"] {
        border: none;
        background-color: rgba(240, 242, 246, 0.6);
        border-radius: 10px;
    }
    div[data-testid="stChatMessage"] [data-testid="stChatMessageContent"] {
        border: none !important;
        box-shadow: none !important;
    }
    div[data-testid="stHorizontalBlock"] {
        gap: 2rem;
    }
    img {
        border-radius: 10px;
    }
    .code-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.5rem;
    }
</style>
""", unsafe_allow_html=True)

# æ˜¾ç¤ºä¾§è¾¹æ 
with st.sidebar:
    display_sidebar_user_info(st.session_state.user_info)

# é¡µé¢æ ‡é¢˜
st.title("æ•°æ®åˆ†æ")

# åˆå§‹åŒ–ä¼šè¯çŠ¶æ€
if "messages" not in st.session_state:  # å­˜å‚¨å¯¹è¯å†å²
    st.session_state.messages = []
if "df" not in st.session_state:  # å­˜å‚¨æ•°æ®æ¡†
    st.session_state.df = None
if "file_uploaded" not in st.session_state:  # æ ‡è®°æ–‡ä»¶æ˜¯å¦å·²ä¸Šä¼ 
    st.session_state.file_uploaded = False
if "column_descriptions" not in st.session_state:  # å­˜å‚¨åˆ—æè¿°ä¿¡æ¯
    st.session_state.column_descriptions = {}
if "descriptions_provided" not in st.session_state:  # æ ‡è®°æ˜¯å¦å·²æä¾›åˆ—æè¿°
    st.session_state.descriptions_provided = False
if "visualization_code" not in st.session_state:  # ç»Ÿä¸€å­˜å‚¨å¯è§†åŒ–ä»£ç 
    st.session_state.visualization_code = None
if "chart_status" not in st.session_state:  # å­˜å‚¨å›¾è¡¨ç”ŸæˆçŠ¶æ€
    st.session_state.chart_status = None
if "file_path" not in st.session_state:  # å­˜å‚¨æ–‡ä»¶è·¯å¾„
    st.session_state.file_path = None
if "current_image" not in st.session_state:  # å­˜å‚¨å½“å‰ç”Ÿæˆçš„å›¾ç‰‡è·¯å¾„
    st.session_state.current_image = None
if "need_ai_response" not in st.session_state:  # æ ‡è®°æ˜¯å¦éœ€è¦å¤„ç†AIå“åº”
    st.session_state.need_ai_response = False
if "current_input" not in st.session_state:  # å­˜å‚¨å½“å‰ç”¨æˆ·è¾“å…¥
    st.session_state.current_input = ""
if "is_thinking" not in st.session_state:  # æ ‡è®°AIæ˜¯å¦æ­£åœ¨æ€è€ƒ
    st.session_state.is_thinking = False
if "temp_response" not in st.session_state:  # ä¸´æ—¶å­˜å‚¨AIå“åº”
    st.session_state.temp_response = ""
if "should_regenerate" not in st.session_state:  # æ ‡è®°æ˜¯å¦åº”è¯¥é‡æ–°ç”Ÿæˆå›¾è¡¨
    st.session_state.should_regenerate = False
if "file_type" not in st.session_state:  # å­˜å‚¨æ–‡ä»¶ç±»å‹
    st.session_state.file_type = None
if "mysql_connection" not in st.session_state:  # å­˜å‚¨MySQLè¿æ¥
    st.session_state.mysql_connection = None
if "mysql_tables" not in st.session_state:  # å­˜å‚¨MySQLè¡¨åˆ—è¡¨
    st.session_state.mysql_tables = None
if "mysql_selected_table" not in st.session_state:
    st.session_state.mysql_selected_table = None
if "mysql_connection_form_submitted" not in st.session_state:
    st.session_state.mysql_connection_form_submitted = False
if "mysql_data_fetched" not in st.session_state:
    st.session_state.mysql_data_fetched = False
if "mysql_fetch_error" not in st.session_state:
    st.session_state.mysql_fetch_error = None
if "mysql_fetch_progress" not in st.session_state:
    st.session_state.mysql_fetch_progress = 0
if "mysql_fetch_status" not in st.session_state:
    st.session_state.mysql_fetch_status = ""
if "mysql_connection_info" not in st.session_state:
    st.session_state.mysql_connection_info = None
if "mysql_step" not in st.session_state:
    st.session_state.mysql_step = "connect"  # å¯èƒ½çš„å€¼: "connect", "select_table", "fetch_data", "data_loaded"

# ä»…åœ¨åˆå§‹é˜¶æ®µæ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç»„ä»¶
if not st.session_state.file_uploaded:
    # æ·»åŠ æ•°æ®æ¥æºé€‰æ‹©
    data_source = st.radio(
        "è¯·é€‰æ‹©æ•°æ®æ¥æº",
        ["æœ¬åœ°æ–‡ä»¶", "MySQLæ•°æ®åº“"],
        index=0
    )
    
    if data_source == "æœ¬åœ°æ–‡ä»¶":
        # æ·»åŠ æ–‡ä»¶ç±»å‹é€‰æ‹©ä¸‹æ‹‰èœå•
        file_type = st.selectbox(
            "è¯·é€‰æ‹©æ•°æ®æ–‡ä»¶ç±»å‹",
            ["CSV", "Excel"],
            index=0
        )
        
        # æ ¹æ®é€‰æ‹©çš„æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ–‡ä»¶ä¸Šä¼ å™¨
        if file_type == "CSV":
            uploaded_file = st.file_uploader("è¯·ä¸Šä¼ æ‚¨çš„CSVæ–‡ä»¶", type=['csv'])
        else:  # Excel
            uploaded_file = st.file_uploader("è¯·ä¸Šä¼ æ‚¨çš„Excelæ–‡ä»¶", type=['xlsx', 'xls'])

        # ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
        if uploaded_file is not None:
            # ä¿å­˜æ–‡ä»¶ç±»å‹
            st.session_state.file_type = file_type
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šæ–‡ä»¶æ‰©å±•å
            file_extension = '.csv' if file_type == "CSV" else '.xlsx'
            
            # ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
            if not os.path.exists('data'):
                os.makedirs('data')
                
            # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åå¹¶ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶åˆ°æœ¬åœ°
            file_name = f"data/{uuid.uuid4().hex}{file_extension}"
            with open(file_name, "wb") as f:
                f.write(uploaded_file.getbuffer())
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹è¯»å–æ•°æ®
            try:
                if file_type == "CSV":
                    st.session_state.df = pd.read_csv(file_name)
                else:  # Excel
                    # æ·»åŠ æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                    st.write(f"æ­£åœ¨è¯»å–æ–‡ä»¶: {file_name}")
                    st.write(f"æ–‡ä»¶å¤§å°: {os.path.getsize(file_name)} å­—èŠ‚")
                    
                    # å°è¯•ä½¿ç”¨openpyxlå¼•æ“è¯»å–
                    try:
                        st.session_state.df = pd.read_excel(file_name, engine='openpyxl')
                    except Exception as e1:
                        st.write(f"ä½¿ç”¨openpyxlå¼•æ“å¤±è´¥: {str(e1)}")
                        # å°è¯•ä½¿ç”¨xlrdå¼•æ“
                        try:
                            st.session_state.df = pd.read_excel(file_name, engine='xlrd')
                        except Exception as e2:
                            st.write(f"ä½¿ç”¨xlrdå¼•æ“å¤±è´¥: {str(e2)}")
                            raise Exception(f"æ— æ³•è¯»å–Excelæ–‡ä»¶ã€‚openpyxlé”™è¯¯: {str(e1)}, xlrdé”™è¯¯: {str(e2)}")
            except Exception as e:
                st.error(f"è¯»å–æ–‡ä»¶æ—¶å‡ºé”™: {str(e)}")
                st.error("è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ä¸”åŒ…å«æ•°æ®")
                st.stop()
            
            # æ›´æ–°çŠ¶æ€
            st.session_state.file_uploaded = True  # æ›´æ–°æ–‡ä»¶ä¸Šä¼ çŠ¶æ€
            st.session_state.file_path = file_name  # æ›´æ–°æ–‡ä»¶å
            # ä¸ºæ¯ä¸€åˆ—åˆ›å»ºç©ºæè¿°å­—å…¸
            st.session_state.column_descriptions = {col: "" for col in st.session_state.df.columns}
            st.rerun()  # é‡æ–°è¿è¡Œåº”ç”¨ä»¥æ›´æ–°UI
    
    else:  # MySQLæ•°æ®åº“
        # æ­¥éª¤1: è¿æ¥æ•°æ®åº“
        if st.session_state.mysql_step == "connect":
            st.subheader("æ­¥éª¤1: è¿æ¥MySQLæ•°æ®åº“")
            
            # åˆ›å»ºè¾“å…¥å­—æ®µ
            col1, col2 = st.columns(2)
            
            with col1:
                host = st.text_input("æœåŠ¡å™¨åœ°å€", value="localhost")
                port = st.number_input("ç«¯å£", min_value=1, max_value=65535, value=3306)
                user = st.text_input("ç”¨æˆ·å")
                password = st.text_input("å¯†ç ", type="password")
            
            with col2:
                database = st.text_input("æ•°æ®åº“å")
            
            # è¿æ¥æŒ‰é’®
            if st.button("è¿æ¥æ•°æ®åº“"):
                # ä¿å­˜è¿æ¥ä¿¡æ¯åˆ°session state
                st.session_state.mysql_connection_info = {
                    "host": host,
                    "port": port,
                    "user": user,
                    "password": password,
                    "database": database
                }
                
                # å°è¯•è¿æ¥MySQLæ•°æ®åº“
                connection, error = connect_mysql(
                    host=host,
                    port=port,
                    user=user,
                    password=password,
                    database=database
                )
                
                if error:
                    st.error(f"è¿æ¥å¤±è´¥: {error}")
                else:
                    # ä¿å­˜è¿æ¥å¯¹è±¡åˆ°session state
                    st.session_state.mysql_connection = connection
                    
                    # è·å–æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨
                    tables = get_mysql_tables(connection)
                    
                    if not tables:
                        st.warning("æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°è¡¨")
                    else:
                        # ä¿å­˜è¡¨åˆ—è¡¨åˆ°session state
                        st.session_state.mysql_tables = tables
                        st.session_state.mysql_connection_form_submitted = True
                        st.session_state.mysql_step = "select_table"
                        st.success("æ•°æ®åº“è¿æ¥æˆåŠŸï¼è¯·é€‰æ‹©è¦åˆ†æçš„è¡¨ã€‚")
                        st.rerun() 